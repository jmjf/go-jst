# Add JobStatus GET feature

## Get by job id and business date

I want to be able to get a list of job statuses for a job id and business date so I can use the data to report on job status.

Steps:

* Get job id and business date from query parameters.
* Build a DTO with the values, leaving all other values zero-value.
* Call the repo with the DTO to get the data.
* Return the received data.

I'm passing a DTO because I'm conscious of the "query by any values" story and choosing to be slightly ahead and reduce rework vs. passing job id and business date values to the repo.

What can go wrong? What can go right?

* Get job id and business date from query parameters. (receives DTO from controller)
  * If either value is zero value -> invalid query error (HTTP 400).
* Call the repo with the DTO to get the data.
  * If no data found, repo returns not found error.
  * Use case ignores not found and returns empty results as okay.
* Return the received data.

Tests to write:

* `Test_jobStatusUC_GetQuery_ZeroQueryTermReturnsError`
* `Test_jobStatusUC_GetQuery_RepoErrorReturnsError`
* `Test_jobStatusUC_GetQuery_NoDataReturnsEmptyResult`
* `Test_jobStatusUC_GetQuery_DataFoundReturnsResult`

I've written the first test and it's failing because it wants an error but gets `[]` because the use case just returns empty (proves test can fail). Then I added a check for the error condition and returned the error. Test passes.

Wrote the test for repo error. Failing because it's not getting the error it expected. Call the repo and return error if error. Test passes.

Wrote the test for no data. Tested with mock returning a repo "other" error and fails because it gets the error instead of empty result. Change mock to return an empty row, fails because it's getting a "not implemented" error, which is what I have the use case returning at this stage. Add code to handle not found error and change the use case to return the result and nil error. Test passes.

Wrote the test for data okay. Tested with mock returning only one row and it fails because it expects two rows. Tested returning mismatched data and it fails for mismatched data. Change to return correct data. Test passes.

Tests above are for `db_sqlpgx` only.

**COMMIT:** FEAT: add use case to get by job id and business date (not in API yet); add repo code in db_sqlpgx

## Build tests for db_gormpg

I want to build the same tests for `db_gormpg` so I have better test coverage.

Main things to note

* `gorm` doesn't wrap queries in a transaction (does for exec).
* Using `gorm`'s `Where()` method uses `SELECT *`. The `*` needs to be escaped in the regexp like `SELECT \* FROM "JobStatus"`.
* Otherwise, the tests are basically the same except I call `gormBeforeEach()`.
* I renamed the tests for `dbsqlpg` to have `dbsqlpg` in the name so they're consistent with `gorm` tests.

Tests are built and passing.

**COMMIT:** TEST: add unit tests for gorm repo

## Get by any query on values

I want to be able to get a list of job statuses using a query on any combination of values so I have more reporting flexibility.

This story requires building the `WHERE` clause based on data in the query parameters.
