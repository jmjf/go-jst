# Interlude -- Reorganize server setup and startup

## Move repos up one level

Repos are in `jobStatus/db/*/repo.go`. I want to remove the `db` layer and prefix `*` with `db` so they're grouped and easier to get to.

* Move directories and renamed.
* Change test import paths. Tests pass.
* Change `cmd` import paths. Run `database/sql`/`pgx`, responses and logs as expected.

**COMMIT:** REFACTOR: move repos up one layer

I want to make the repo `New*()` methods generic so I can use the same call regardless of the repo I select.

* Change repo object to `repoDb` in all repos
* Change repo `New*()` to `NewRepoDb()`; change references in all repos
* Change test import paths. Tests pass.
* Change `cmd` import paths. Run `dbSqlPgx`, responses and logs as expected.

**COMMIT:** REFACTOR: make repo `New*()` methods generic

I want to move the database connection process into each repo so I can use the same call regardless of the ORM I select.

For tests, I need to pass a mock database connection. So, export the database handle `repo.DB`. Then in tests, I can set the database handle to the mock db.

* Change `NewRepoDb()` to accept a DSN string instead of a database connection object.
* Create repo `Open()` and `Close()`; `Open()` requires a pointer receiver so it can set `repo.DB`
* Change tests to set `repo.DB` to the mock.
* In `cmd/*/main.go`
  * Remove database connection code, keep URL/DSN setup.
  * Call `NewRepoDb()` with URL/DSN string.
  * Call repo `Open()`; defer repo `Close()`

`gorm` uses connection pools, so doesn't include a direct `Close()` method. I have to get the underlying `sql.DB` and call close on that. But this approach means each repo is opening (and closing) its own connection pool. That may not be a good idea. I need to investigate the consequences of having several repos and connection pools. `gorm`'s `NewRepoDb` may need to be different.

For `dbInMem`, `Open()` and `Close()` just return `nil`. There is nothing to open or close, so they're no-ops.

**COMMIT:** REFACTOR: move ORM/database specific open/close code into repos
